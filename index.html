<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Mapas - Nin Online</title>
    <!-- Tailwind CSS para Estilo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome para Ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden; /* Impede scroll na página inteira, apenas nas áreas específicas */
        }

        /* Área do Canvas com Grid */
        #map-canvas {
            background-color: #1a1a1a;
            background-image: 
                linear-gradient(#2a2a2a 1px, transparent 1px),
                linear-gradient(90deg, #2a2a2a 1px, transparent 1px);
            background-size: 32px 32px; /* Grid de 32x32 pixels */
            cursor: grab;
            position: relative;
            overflow: hidden;
            width: 2000px; /* Tamanho virtual do mundo */
            height: 2000px;
            transform-origin: 0 0;
        }

        #map-canvas.grabbing {
            cursor: grabbing;
        }

        /* Estilo das imagens no mapa */
        .map-piece {
            position: absolute;
            user-select: none;
            border: 1px solid transparent;
            transition: border 0.1s;
        }

        .map-piece:hover {
            border: 1px solid rgba(255, 255, 255, 0.5);
            cursor: move;
            z-index: 10;
        }

        .map-piece.selected {
            border: 2px solid #3b82f6; /* Azul selection */
            z-index: 20;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        /* Scrollbars customizadas */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen flex flex-col">

    <!-- LOGIN OVERLAY -->
    <div id="login-overlay" class="fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center">
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl w-96 border border-gray-700">
            <h2 class="text-2xl font-bold mb-6 text-center text-blue-400">Acesso ao Editor</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Email</label>
                    <input type="email" id="email" class="w-full bg-gray-700 border border-gray-600 rounded p-2 focus:outline-none focus:border-blue-500" required placeholder="admin@ninonline.com">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Senha</label>
                    <input type="password" id="password" class="w-full bg-gray-700 border border-gray-600 rounded p-2 focus:outline-none focus:border-blue-500" required placeholder="******">
                </div>
                <div id="login-error" class="text-red-500 text-sm hidden"></div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition">
                    Entrar
                </button>
            </form>
        </div>
    </div>

    <!-- MAIN APP (Hidden until login) -->
    <div id="app-container" class="flex-1 flex overflow-hidden hidden">
        
        <!-- SIDEBAR ESQUERDA: ASSETS -->
        <div class="w-64 bg-gray-800 border-r border-gray-700 flex flex-col shadow-lg z-20">
            <div class="p-4 border-b border-gray-700 bg-gray-800">
                <h3 class="font-bold text-lg"><i class="fas fa-images mr-2"></i>Mapas Disponíveis</h3>
                <p class="text-xs text-gray-400 mt-1">Clique para adicionar ao palco</p>
            </div>
            
            <div id="assets-list" class="flex-1 overflow-y-auto p-2 space-y-2">
                <!-- Lista de imagens será gerada via JS -->
                <div class="text-gray-500 text-center text-sm p-4">Carregando lista...</div>
            </div>

            <div class="p-4 border-t border-gray-700">
                <button id="logout-btn" class="w-full bg-red-600/20 hover:bg-red-600 text-red-100 py-1 px-3 rounded text-sm transition">
                    <i class="fas fa-sign-out-alt mr-1"></i> Sair
                </button>
            </div>
        </div>

        <!-- ÁREA CENTRAL: CANVAS -->
        <div class="flex-1 relative bg-gray-900 overflow-hidden flex flex-col">
            <!-- Toolbar Superior -->
            <div class="h-12 bg-gray-800 border-b border-gray-700 flex items-center justify-between px-4 z-10 shadow">
                <div class="flex items-center space-x-4">
                    <span class="text-sm font-mono text-gray-400" id="coords-display">X: 0, Y: 0</span>
                </div>
                <div class="flex space-x-2">
                    <button id="save-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-1 rounded text-sm flex items-center shadow">
                        <i class="fas fa-save mr-2"></i> Salvar no Firebase
                    </button>
                </div>
            </div>

            <!-- Wrapper para scroll -->
            <div class="flex-1 overflow-auto relative" id="canvas-wrapper">
                <div id="map-canvas">
                    <!-- As imagens do mapa serão inseridas aqui -->
                </div>
            </div>
        </div>

        <!-- SIDEBAR DIREITA: PROPRIEDADES -->
        <div class="w-72 bg-gray-800 border-l border-gray-700 flex flex-col shadow-lg z-20">
            <div class="p-4 border-b border-gray-700 bg-gray-800">
                <h3 class="font-bold text-lg"><i class="fas fa-sliders-h mr-2"></i>Propriedades</h3>
            </div>
            
            <div id="properties-panel" class="flex-1 overflow-y-auto p-4 space-y-4 hidden">
                <div>
                    <label class="text-xs text-gray-400 uppercase font-bold">Arquivo</label>
                    <input type="text" id="prop-src" disabled class="w-full bg-gray-900 text-gray-500 text-sm p-2 rounded mt-1 border border-gray-700">
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="text-xs text-gray-400 uppercase font-bold">X</label>
                        <input type="number" id="prop-x" class="w-full bg-gray-700 text-white p-2 rounded mt-1 border border-gray-600 focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 uppercase font-bold">Y</label>
                        <input type="number" id="prop-y" class="w-full bg-gray-700 text-white p-2 rounded mt-1 border border-gray-600 focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 uppercase font-bold">Z-Index</label>
                        <input type="number" id="prop-z" class="w-full bg-gray-700 text-white p-2 rounded mt-1 border border-gray-600 focus:border-blue-500 outline-none">
                    </div>
                </div>

                <hr class="border-gray-700">

                <div>
                    <label class="text-xs text-gray-400 uppercase font-bold">Mobs (Inimigos)</label>
                    <textarea id="prop-mobs" rows="3" placeholder="Ex: Lobo:3, Urso:1" class="w-full bg-gray-700 text-white p-2 rounded mt-1 border border-gray-600 focus:border-blue-500 outline-none"></textarea>
                </div>

                <div>
                    <label class="text-xs text-gray-400 uppercase font-bold">Drops</label>
                    <textarea id="prop-drops" rows="3" placeholder="Ex: Pele, Ouro" class="w-full bg-gray-700 text-white p-2 rounded mt-1 border border-gray-600 focus:border-blue-500 outline-none"></textarea>
                </div>

                <div>
                    <label class="text-xs text-gray-400 uppercase font-bold">Missões / NPCs</label>
                    <textarea id="prop-missions" rows="3" placeholder="Ex: Falar com Velho Jack" class="w-full bg-gray-700 text-white p-2 rounded mt-1 border border-gray-600 focus:border-blue-500 outline-none"></textarea>
                </div>

                <button id="delete-btn" class="w-full mt-4 bg-red-600 hover:bg-red-700 text-white py-2 rounded transition">
                    <i class="fas fa-trash mr-2"></i> Remover Imagem
                </button>
            </div>

            <div id="no-selection" class="flex-1 flex flex-col items-center justify-center text-gray-500 p-8 text-center">
                <i class="fas fa-mouse-pointer text-4xl mb-4 opacity-50"></i>
                <p>Selecione uma imagem no mapa para editar suas propriedades.</p>
            </div>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded shadow-lg transform translate-y-20 transition-transform duration-300 border-l-4 border-blue-500 z-50">
        Mensagem aqui
    </div>

    <!-- SCRIPTS -->
    <script type="module">
        // Importação dos módulos Firebase via CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // Configuração do Firebase fornecida
        const firebaseConfig = {
            apiKey: "AIzaSyDggIKgs1Ci8hsqyGf4_NrCgJopiisFZvo",
            authDomain: "mapasninonline.firebaseapp.com",
            projectId: "mapasninonline",
            storageBucket: "mapasninonline.firebasestorage.app",
            messagingSenderId: "891556969621",
            appId: "1:891556969621:web:1a67ef0c1f7b6323fd6f9c",
            measurementId: "G-YH6SWRVTNM"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- ESTADO DA APLICAÇÃO ---
        let currentMapData = []; // Array que guarda o estado do mapa
        let selectedElementId = null;
        
        // --- CONFIGURAÇÃO DE IMAGENS ---
        // OBS: Como o Javascript não pode listar arquivos de uma pasta automaticamente sem API,
        // definimos uma lista de arquivos esperados. Adicione os nomes dos seus arquivos aqui.
        const availableMapImages = [
            'map_base_1.png',
            'floresta_arvores.png',
            'vila_casa.png',
            'rio_curva.png',
            'pedras.png',
            // Adicione os nomes exatos dos seus arquivos na pasta 'maps/'
        ];

        // --- UI REFS ---
        const loginOverlay = document.getElementById('login-overlay');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const mapCanvas = document.getElementById('map-canvas');
        const assetsList = document.getElementById('assets-list');
        const propPanel = document.getElementById('properties-panel');
        const noSelection = document.getElementById('no-selection');

        // --- AUTHENTICATION LOGIC ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Usuário logado:", user.email);
                loginOverlay.classList.add('hidden');
                appContainer.classList.remove('hidden');
                appContainer.classList.add('flex');
                initEditor();
            } else {
                console.log("Usuário não logado");
                loginOverlay.classList.remove('hidden');
                appContainer.classList.add('hidden');
                appContainer.classList.remove('flex');
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('login-error');
            
            errorMsg.classList.add('hidden');
            
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                errorMsg.textContent = "Erro ao logar: " + error.message;
                errorMsg.classList.remove('hidden');
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth);
        });

        // --- EDITOR LOGIC ---

        function initEditor() {
            loadAssetsList();
            loadMapDataFromFirebase();
        }

        function loadAssetsList() {
            assetsList.innerHTML = '';
            
            // Simulação de carregar imagens da pasta maps
            // Nota: Se a imagem não existir na pasta, ela aparecerá quebrada.
            availableMapImages.forEach(filename => {
                const div = document.createElement('div');
                div.className = "bg-gray-700 p-2 rounded cursor-pointer hover:bg-gray-600 transition flex items-center gap-2 group";
                
                const imgPath = `./maps/${filename}`;
                
                div.innerHTML = `
                    <div class="w-10 h-10 bg-gray-900 rounded overflow-hidden flex items-center justify-center border border-gray-600">
                        <img src="${imgPath}" alt="${filename}" class="max-w-full max-h-full object-contain" onerror="this.style.display='none';this.parentElement.innerHTML='<span class=\\'text-xs\\'>Erro</span>'">
                    </div>
                    <span class="text-sm truncate flex-1">${filename}</span>
                    <i class="fas fa-plus text-blue-400 opacity-0 group-hover:opacity-100 transition"></i>
                `;

                div.addEventListener('click', () => {
                    addMapPieceToCanvas(imgPath);
                });

                assetsList.appendChild(div);
            });
            
            // Botão para adicionar URL externa (fallback caso não tenha pasta maps)
            const customBtn = document.createElement('div');
            customBtn.className = "mt-4 border-t border-gray-600 pt-2";
            customBtn.innerHTML = `
                <button class="w-full text-xs bg-gray-700 hover:bg-gray-600 p-2 rounded text-gray-300">
                    + Adicionar URL Customizada
                </button>
            `;
            customBtn.querySelector('button').addEventListener('click', () => {
                const url = prompt("Cole a URL da imagem:");
                if(url) addMapPieceToCanvas(url);
            });
            assetsList.appendChild(customBtn);
        }

        // --- CANVAS & MANIPULATION ---

        function addMapPieceToCanvas(src, existingData = null) {
            const id = existingData ? existingData.id : 'map_' + Date.now();
            
            const piece = document.createElement('div');
            piece.className = 'map-piece';
            piece.id = id;
            
            const img = document.createElement('img');
            img.src = src;
            img.style.pointerEvents = 'none'; // Importante para o drag funcionar na div pai
            img.onload = () => {
                 // Ajustar tamanho se necessário ou deixar natural
            };
            
            piece.appendChild(img);

            // Dados iniciais ou carregados
            const data = existingData || {
                id: id,
                src: src,
                x: 0,
                y: 0,
                z: 1,
                mobs: '',
                drops: '',
                missions: ''
            };

            // Se for novo, adiciona ao array global
            if (!existingData) {
                // Centralizar na view atual (simplificado para 100,100 por enquanto)
                data.x = 100;
                data.y = 100;
                currentMapData.push(data);
            }

            // Aplicar posição
            updateElementDOM(piece, data);

            // Eventos
            piece.addEventListener('mousedown', (e) => startDragging(e, piece, data));
            piece.addEventListener('click', (e) => {
                e.stopPropagation();
                selectPiece(data.id);
            });

            mapCanvas.appendChild(piece);
        }

        function updateElementDOM(el, data) {
            el.style.left = `${data.x}px`;
            el.style.top = `${data.y}px`;
            el.style.zIndex = data.z;
        }

        // --- DRAG AND DROP LOGIC ---
        let isDragging = false;
        let activeDragPiece = null;
        let activeDragData = null;
        let dragOffset = { x: 0, y: 0 };

        function startDragging(e, piece, data) {
            if (e.button !== 0) return; // Apenas botão esquerdo
            e.preventDefault();
            
            selectPiece(data.id); // Seleciona ao começar a arrastar
            
            isDragging = true;
            activeDragPiece = piece;
            activeDragData = data;
            
            // Calcular offset do clique em relação ao elemento
            const rect = piece.getBoundingClientRect();
            const canvasRect = mapCanvas.getBoundingClientRect();
            
            // A posição do mouse relativa ao elemento
            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;
            
            document.addEventListener('mousemove', handleDragMove);
            document.addEventListener('mouseup', stopDragging);
        }

        function handleDragMove(e) {
            if (!isDragging) return;
            
            const canvasRect = mapCanvas.getBoundingClientRect();
            
            // Nova posição relativa ao canvas
            let newX = e.clientX - canvasRect.left - dragOffset.x;
            let newY = e.clientY - canvasRect.top - dragOffset.y;
            
            // Snap to grid (opcional, aqui a cada 1px para ser pixel perfect, ou 32px para grid)
            // Para "Pixel Perfect", não arredondamos para grid grande, mas usamos Math.round
            newX = Math.round(newX);
            newY = Math.round(newY);

            // Limites (opcional)
            // newX = Math.max(0, newX);
            // newY = Math.max(0, newY);

            // Atualizar DOM
            activeDragPiece.style.left = `${newX}px`;
            activeDragPiece.style.top = `${newY}px`;
            
            // Atualizar Data
            activeDragData.x = newX;
            activeDragData.y = newY;
            
            // Atualizar inputs se estiver selecionado
            if (selectedElementId === activeDragData.id) {
                document.getElementById('prop-x').value = newX;
                document.getElementById('prop-y').value = newY;
            }
            
            updateCoords(newX, newY);
        }

        function stopDragging() {
            isDragging = false;
            activeDragPiece = null;
            activeDragData = null;
            document.removeEventListener('mousemove', handleDragMove);
            document.removeEventListener('mouseup', stopDragging);
        }

        // --- SELEÇÃO E PROPRIEDADES ---

        function selectPiece(id) {
            // Remove seleção anterior
            const prev = document.querySelector('.map-piece.selected');
            if (prev) prev.classList.remove('selected');
            
            selectedElementId = id;
            const el = document.getElementById(id);
            if (el) el.classList.add('selected');
            
            const data = currentMapData.find(d => d.id === id);
            if (data) {
                showProperties(data);
            }
        }

        function showProperties(data) {
            noSelection.classList.add('hidden');
            propPanel.classList.remove('hidden');

            document.getElementById('prop-src').value = data.src;
            document.getElementById('prop-x').value = data.x;
            document.getElementById('prop-y').value = data.y;
            document.getElementById('prop-z').value = data.z || 1;
            document.getElementById('prop-mobs').value = data.mobs || '';
            document.getElementById('prop-drops').value = data.drops || '';
            document.getElementById('prop-missions').value = data.missions || '';
        }

        // Deselecionar ao clicar no fundo
        mapCanvas.addEventListener('mousedown', (e) => {
            if (e.target === mapCanvas) {
                selectedElementId = null;
                const prev = document.querySelector('.map-piece.selected');
                if (prev) prev.classList.remove('selected');
                noSelection.classList.remove('hidden');
                propPanel.classList.add('hidden');
            }
        });

        // Listeners dos inputs de propriedade
        const inputs = ['prop-x', 'prop-y', 'prop-z', 'prop-mobs', 'prop-drops', 'prop-missions'];
        inputs.forEach(id => {
            document.getElementById(id).addEventListener('input', (e) => {
                if (!selectedElementId) return;
                
                const data = currentMapData.find(d => d.id === selectedElementId);
                if (!data) return;

                const val = e.target.value;
                const field = id.replace('prop-', '');
                
                if (field === 'x' || field === 'y' || field === 'z') {
                    data[field] = parseInt(val) || 0;
                    const el = document.getElementById(selectedElementId);
                    updateElementDOM(el, data);
                } else {
                    data[field] = val;
                }
            });
        });

        // Deletar item
        document.getElementById('delete-btn').addEventListener('click', () => {
            if (!selectedElementId) return;
            
            const el = document.getElementById(selectedElementId);
            if (el) el.remove();
            
            currentMapData = currentMapData.filter(d => d.id !== selectedElementId);
            
            selectedElementId = null;
            noSelection.classList.remove('hidden');
            propPanel.classList.add('hidden');
        });

        function updateCoords(x, y) {
            document.getElementById('coords-display').innerText = `X: ${x}, Y: ${y}`;
        }

        // --- FIRESTORE SAVE/LOAD ---

        document.getElementById('save-btn').addEventListener('click', async () => {
            const btn = document.getElementById('save-btn');
            const originalText = btn.innerHTML;
            
            try {
                btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Salvando...`;
                
                // Salvar no documento 'global_map' na coleção 'maps_data'
                // Você pode mudar essa estrutura conforme necessário
                await setDoc(doc(db, "maps_data", "global_map"), {
                    pieces: currentMapData,
                    updatedAt: new Date(),
                    updatedBy: auth.currentUser.email
                });
                
                showToast("Mapa salvo com sucesso no Firebase!", "success");
            } catch (e) {
                console.error("Erro ao salvar:", e);
                showToast("Erro ao salvar: " + e.message, "error");
            } finally {
                btn.innerHTML = originalText;
            }
        });

        async function loadMapDataFromFirebase() {
            try {
                const docRef = doc(db, "maps_data", "global_map");
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const savedData = docSnap.data();
                    if (savedData.pieces && Array.isArray(savedData.pieces)) {
                        // Limpar canvas atual
                        mapCanvas.innerHTML = '';
                        currentMapData = [];
                        
                        // Recriar elementos
                        savedData.pieces.forEach(data => {
                            addMapPieceToCanvas(data.src, data);
                        });
                        showToast("Mapa carregado do servidor.", "success");
                    }
                } else {
                    console.log("Nenhum mapa salvo encontrado, iniciando em branco.");
                }
            } catch (e) {
                console.error("Erro ao carregar:", e);
                showToast("Erro ao carregar dados.", "error");
            }
        }

        function showToast(msg, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = `fixed bottom-4 right-4 text-white px-6 py-3 rounded shadow-lg transform transition-transform duration-300 border-l-4 z-50 ${
                type === 'error' ? 'bg-red-800 border-red-500' : 
                type === 'success' ? 'bg-green-800 border-green-500' : 
                'bg-gray-800 border-blue-500'
            }`;
            
            // Slide in
            toast.style.transform = 'translateY(0)';
            
            setTimeout(() => {
                toast.style.transform = 'translateY(150%)'; // Slide out
            }, 3000);
        }

    </script>
</body>
</html>
