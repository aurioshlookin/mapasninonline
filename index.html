<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Nin Online</title>
    <!-- Tailwind CSS para Estilo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome para Ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden; 
            background-color: #0f0f0f;
        }

        /* Área do Canvas */
        #map-canvas {
            background-color: #1a1a1a; /* Fundo sólido padrão */
            position: relative;
            overflow: hidden;
            width: 4000px; /* Mundo expandido */
            height: 4000px;
            transform-origin: 0 0; /* Zoom a partir do topo esquerdo */
            transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        /* Classe para ativar a Grade visualmente */
        #map-canvas.show-grid {
            background-image: 
                linear-gradient(#333 1px, transparent 1px),
                linear-gradient(90deg, #333 1px, transparent 1px);
            background-size: 32px 32px; 
        }

        /* Estilo para modo visitante */
        #map-canvas.readonly {
            cursor: grab; /* Permite arrastar o canvas para navegar (Pan) */
        }
        #map-canvas.readonly:active {
            cursor: grabbing;
        }
        
        /* Estilo para modo editor */
        #map-canvas.editable {
            cursor: grab;
        }
        #map-canvas.editable:active {
            cursor: grabbing;
        }

        /* Estilo das imagens no mapa */
        .map-piece {
            position: absolute;
            user-select: none;
            border: 1px solid transparent;
            transition: border 0.1s, box-shadow 0.2s;
        }

        /* Interatividade apenas no modo editor */
        .editable .map-piece:hover {
            border: 1px solid rgba(255, 255, 255, 0.5);
            cursor: move;
            z-index: 100;
        }

        .editable .map-piece.selected {
            border: 2px solid #3b82f6; 
            z-index: 200;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.6);
        }

        /* Tooltip de Informação (Visitante) - Agora ativado por clique */
        .info-popup {
            position: absolute;
            background: rgba(15, 23, 42, 0.95);
            color: white;
            padding: 12px;
            border-radius: 8px;
            z-index: 1000;
            font-size: 13px;
            max-width: 250px;
            border: 1px solid #4a5568;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            animation: fadeIn 0.2s ease-out;
            pointer-events: none; /* Deixa clicar através se necessário, ou auto se tiver botões */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Scrollbars customizadas */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-gray-900 text-white h-screen flex flex-col">

    <!-- LOGIN MODAL (Inicia oculto) -->
    <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center hidden">
        <div class="bg-gray-800 p-8 rounded-lg shadow-2xl w-96 border border-gray-700 relative">
            <button id="close-login" class="absolute top-2 right-4 text-gray-400 hover:text-white text-xl">&times;</button>
            <h2 class="text-2xl font-bold mb-6 text-center text-blue-400">Acesso Admin</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Email</label>
                    <input type="email" id="email" class="w-full bg-gray-700 border border-gray-600 rounded p-2 focus:outline-none focus:border-blue-500" required placeholder="admin@ninonline.com">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Senha</label>
                    <input type="password" id="password" class="w-full bg-gray-700 border border-gray-600 rounded p-2 focus:outline-none focus:border-blue-500" required placeholder="******">
                </div>
                <div id="login-error" class="text-red-500 text-sm hidden"></div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition">
                    Entrar
                </button>
            </form>
        </div>
    </div>

    <!-- APP CONTAINER -->
    <div id="app-container" class="flex-1 flex overflow-hidden w-full h-full relative">
        
        <!-- SIDEBAR ESQUERDA: ASSETS (Apenas Admin) -->
        <div id="sidebar-assets" class="w-64 bg-gray-800 border-r border-gray-700 flex flex-col shadow-lg z-30 hidden transition-all flex-shrink-0">
            <div class="p-4 border-b border-gray-700 bg-gray-800">
                <h3 class="font-bold text-lg"><i class="fas fa-images mr-2"></i>Assets do GitHub</h3>
                <p class="text-xs text-gray-400 mt-1">Imagens da pasta /maps</p>
            </div>
            
            <div id="assets-list" class="flex-1 overflow-y-auto p-2 space-y-2">
                <div class="text-gray-500 text-center text-sm p-4">Conectando ao GitHub...</div>
            </div>

            <div class="p-4 border-t border-gray-700">
                <button id="logout-btn" class="w-full bg-red-600/20 hover:bg-red-600 text-red-100 py-1 px-3 rounded text-sm transition">
                    <i class="fas fa-sign-out-alt mr-1"></i> Sair do Editor
                </button>
            </div>
        </div>

        <!-- ÁREA CENTRAL: CANVAS -->
        <div class="flex-1 relative bg-gray-900 overflow-hidden flex flex-col min-w-0">
            
            <!-- Toolbar Superior -->
            <div class="h-14 bg-gray-800 border-b border-gray-700 flex items-center justify-between px-4 z-20 shadow shrink-0">
                <!-- Controles de Navegação (Esquerda) -->
                <div class="flex items-center space-x-2">
                    <button id="btn-fit" class="bg-gray-700 hover:bg-gray-600 text-white p-2 rounded text-xs" title="Centralizar Mapa">
                        <i class="fas fa-compress-arrows-alt"></i> Fit
                    </button>
                    <div class="flex items-center bg-gray-700 rounded overflow-hidden">
                        <button id="btn-zoom-out" class="hover:bg-gray-600 text-white px-3 py-1 border-r border-gray-600"><i class="fas fa-minus"></i></button>
                        <span id="zoom-display" class="px-3 text-xs font-mono w-16 text-center">100%</span>
                        <button id="btn-zoom-in" class="hover:bg-gray-600 text-white px-3 py-1 border-l border-gray-600"><i class="fas fa-plus"></i></button>
                    </div>
                    <button id="btn-grid" class="bg-gray-700 hover:bg-gray-600 text-gray-400 hover:text-white p-2 rounded text-xs ml-2" title="Alternar Grade">
                        <i class="fas fa-border-all"></i>
                    </button>
                </div>

                <div class="flex items-center space-x-4">
                    <span class="text-xs font-mono text-gray-500 hidden md:block" id="coords-display">X: 0 Y: 0</span>
                    
                    <!-- Botão Salvar (Apenas Admin) -->
                    <button id="save-btn" class="hidden bg-green-600 hover:bg-green-700 text-white px-4 py-1.5 rounded text-sm items-center shadow transition font-bold">
                        <i class="fas fa-save mr-2"></i> Salvar
                    </button>
                    <!-- Botão Login (Apenas Visitante) -->
                    <button id="login-trigger-btn" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-1.5 rounded text-sm flex items-center shadow transition border border-gray-600">
                        <i class="fas fa-lock mr-2"></i> Admin
                    </button>
                </div>
            </div>

            <!-- Wrapper para scroll e Pan -->
            <div class="flex-1 overflow-auto relative custom-scrollbar bg-gray-950" id="canvas-wrapper">
                <div id="map-canvas" class="readonly">
                    <!-- As imagens do mapa serão inseridas aqui -->
                </div>
            </div>
        </div>

        <!-- SIDEBAR DIREITA: PROPRIEDADES (Apenas Admin) -->
        <div id="sidebar-props" class="w-72 bg-gray-800 border-l border-gray-700 flex flex-col shadow-lg z-30 hidden transition-all flex-shrink-0">
            <div class="p-4 border-b border-gray-700 bg-gray-800">
                <h3 class="font-bold text-lg"><i class="fas fa-sliders-h mr-2"></i>Propriedades</h3>
            </div>
            
            <div id="properties-panel" class="flex-1 overflow-y-auto p-4 space-y-4 hidden">
                <div>
                    <label class="text-xs text-gray-400 uppercase font-bold">Arquivo</label>
                    <input type="text" id="prop-src" disabled class="w-full bg-gray-900 text-gray-500 text-sm p-2 rounded mt-1 border border-gray-700">
                </div>

                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="text-xs text-gray-400 uppercase font-bold">X</label>
                        <input type="number" id="prop-x" class="w-full bg-gray-700 text-white p-2 rounded mt-1 border border-gray-600 focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 uppercase font-bold">Y</label>
                        <input type="number" id="prop-y" class="w-full bg-gray-700 text-white p-2 rounded mt-1 border border-gray-600 focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 uppercase font-bold">Camada (Z)</label>
                        <input type="number" id="prop-z" class="w-full bg-gray-700 text-white p-2 rounded mt-1 border border-gray-600 focus:border-blue-500 outline-none">
                    </div>
                </div>

                <hr class="border-gray-700">

                <div>
                    <label class="text-xs text-gray-400 uppercase font-bold">Mobs (Inimigos)</label>
                    <textarea id="prop-mobs" rows="3" placeholder="Ex: Lobo:3, Urso:1" class="w-full bg-gray-700 text-white p-2 rounded mt-1 border border-gray-600 focus:border-blue-500 outline-none"></textarea>
                </div>

                <div>
                    <label class="text-xs text-gray-400 uppercase font-bold">Drops</label>
                    <textarea id="prop-drops" rows="3" placeholder="Ex: Pele, Ouro" class="w-full bg-gray-700 text-white p-2 rounded mt-1 border border-gray-600 focus:border-blue-500 outline-none"></textarea>
                </div>

                <div>
                    <label class="text-xs text-gray-400 uppercase font-bold">Missões / NPCs</label>
                    <textarea id="prop-missions" rows="3" placeholder="Ex: Falar com Velho Jack" class="w-full bg-gray-700 text-white p-2 rounded mt-1 border border-gray-600 focus:border-blue-500 outline-none"></textarea>
                </div>

                <button id="delete-btn" class="w-full mt-4 bg-red-600 hover:bg-red-700 text-white py-2 rounded transition">
                    <i class="fas fa-trash mr-2"></i> Remover Imagem
                </button>
            </div>

            <div id="no-selection" class="flex-1 flex flex-col items-center justify-center text-gray-500 p-8 text-center">
                <i class="fas fa-mouse-pointer text-4xl mb-4 opacity-50"></i>
                <p>Selecione uma imagem no mapa para editar suas propriedades.</p>
            </div>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded shadow-lg transform translate-y-20 transition-transform duration-300 border-l-4 border-blue-500 z-50">
        Mensagem aqui
    </div>

    <!-- SCRIPTS -->
    <script type="module">
        // Importação dos módulos Firebase via CDN
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // =================================================================
        // CONFIGURAÇÃO DO GITHUB
        // =================================================================
        const GITHUB_USER = 'aurioshlookin'; 
        const GITHUB_REPO = 'mapasninonline';    
        // =================================================================

        const firebaseConfig = {
            apiKey: "AIzaSyDggIKgs1Ci8hsqyGf4_NrCgJopiisFZvo",
            authDomain: "mapasninonline.firebaseapp.com",
            projectId: "mapasninonline",
            storageBucket: "mapasninonline.firebasestorage.app",
            messagingSenderId: "891556969621",
            appId: "1:891556969621:web:1a67ef0c1f7b6323fd6f9c",
            measurementId: "G-YH6SWRVTNM"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- ESTADO DA APLICAÇÃO ---
        let currentMapData = []; 
        let selectedElementId = null;
        let isEditorMode = false;
        let currentZoom = 1;
        let activeInfoPopup = null; // ID do popup ativo
        
        // --- UI REFS ---
        const loginModal = document.getElementById('login-modal');
        const loginForm = document.getElementById('login-form');
        const mapCanvas = document.getElementById('map-canvas');
        const canvasWrapper = document.getElementById('canvas-wrapper');
        const assetsList = document.getElementById('assets-list');
        const propPanel = document.getElementById('properties-panel');
        const noSelection = document.getElementById('no-selection');
        const sidebarAssets = document.getElementById('sidebar-assets');
        const sidebarProps = document.getElementById('sidebar-props');
        const saveBtn = document.getElementById('save-btn');
        const loginTriggerBtn = document.getElementById('login-trigger-btn');
        const coordsDisplay = document.getElementById('coords-display');
        const zoomDisplay = document.getElementById('zoom-display');

        // --- INICIALIZAÇÃO ---
        loadMapDataFromFirebase();

        // --- ZOOM & PAN CONTROLS ---
        
        function updateZoom(newZoom) {
            // Limitar zoom entre 0.1 (10%) e 3 (300%)
            currentZoom = Math.max(0.1, Math.min(newZoom, 3));
            mapCanvas.style.transform = `scale(${currentZoom})`;
            zoomDisplay.innerText = `${Math.round(currentZoom * 100)}%`;
        }

        document.getElementById('btn-zoom-in').addEventListener('click', () => updateZoom(currentZoom + 0.1));
        document.getElementById('btn-zoom-out').addEventListener('click', () => updateZoom(currentZoom - 0.1));
        
        // Atalho: Scroll do mouse para zoom
        canvasWrapper.addEventListener('wheel', (e) => {
            if (e.ctrlKey) {
                e.preventDefault();
                updateZoom(currentZoom + (e.deltaY < 0 ? 0.1 : -0.1));
            }
        });

        // Toggle Grid
        document.getElementById('btn-grid').addEventListener('click', (e) => {
            const btn = e.currentTarget;
            mapCanvas.classList.toggle('show-grid');
            if(mapCanvas.classList.contains('show-grid')) {
                btn.classList.add('text-white', 'bg-blue-600');
                btn.classList.remove('text-gray-400');
            } else {
                btn.classList.remove('text-white', 'bg-blue-600');
                btn.classList.add('text-gray-400');
            }
        });

        // Fit to Screen (Centralizar)
        document.getElementById('btn-fit').addEventListener('click', fitMapToScreen);

        function fitMapToScreen() {
            if (currentMapData.length === 0) return;

            // Calcular Bounding Box de todos os elementos
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;

            currentMapData.forEach(p => {
                // Estimando tamanho base da imagem se não tivermos dimensão carregada ainda
                // Como não sabemos o tamanho exato da img sem ela carregar, usamos uma estimativa ou pegamos do DOM
                const el = document.getElementById(p.id);
                const width = el ? el.offsetWidth : 100; 
                const height = el ? el.offsetHeight : 100;

                if (p.x < minX) minX = p.x;
                if (p.y < minY) minY = p.y;
                if (p.x + width > maxX) maxX = p.x + width;
                if (p.y + height > maxY) maxY = p.y + height;
            });

            // Adicionar margem
            const padding = 100;
            minX -= padding; minY -= padding;
            maxX += padding; maxY += padding;

            const mapWidth = maxX - minX;
            const mapHeight = maxY - minY;
            const viewportWidth = canvasWrapper.clientWidth;
            const viewportHeight = canvasWrapper.clientHeight;

            // Calcular zoom ideal para caber tudo
            const zoomX = viewportWidth / mapWidth;
            const zoomY = viewportHeight / mapHeight;
            let optimalZoom = Math.min(zoomX, zoomY, 1); // Não dar zoom in maior que 100% no fit

            updateZoom(optimalZoom);

            // Centralizar Scroll
            // O centro do conteúdo é (minX + mapWidth/2, minY + mapHeight/2)
            // Precisamos rolar o wrapper para que esse ponto fique no meio
            
            // Fórmula Scroll: (PosiçãoReal * Zoom) - (MetadeViewport)
            const centerX = minX + mapWidth / 2;
            const centerY = minY + mapHeight / 2;

            canvasWrapper.scrollLeft = (centerX * currentZoom) - (viewportWidth / 2);
            canvasWrapper.scrollTop = (centerY * currentZoom) - (viewportHeight / 2);
            
            showToast("Mapa centralizado!");
        }

        // --- AUTH LOGIC ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("Admin logado:", user.email);
                enableEditorMode(true);
                loginModal.classList.add('hidden');
            } else {
                console.log("Modo Visitante");
                enableEditorMode(false);
            }
        });

        function enableEditorMode(enabled) {
            isEditorMode = enabled;
            // Remover popups antigos
            document.querySelectorAll('.info-popup').forEach(el => el.remove());
            activeInfoPopup = null;

            if (enabled) {
                // UI de Editor
                sidebarAssets.classList.remove('hidden');
                sidebarProps.classList.remove('hidden');
                saveBtn.classList.remove('hidden');
                saveBtn.classList.add('flex');
                loginTriggerBtn.classList.add('hidden');
                mapCanvas.classList.remove('readonly');
                mapCanvas.classList.add('editable');
                
                loadGitHubAssets();
            } else {
                // UI de Visitante
                sidebarAssets.classList.add('hidden');
                sidebarProps.classList.add('hidden');
                saveBtn.classList.add('hidden');
                saveBtn.classList.remove('flex');
                loginTriggerBtn.classList.remove('hidden');
                mapCanvas.classList.add('readonly');
                mapCanvas.classList.remove('editable');
                
                if(selectedElementId) selectPiece(null);
            }
        }

        // Login Modal Controls
        loginTriggerBtn.addEventListener('click', () => loginModal.classList.remove('hidden'));
        document.getElementById('close-login').addEventListener('click', () => loginModal.classList.add('hidden'));
        
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorMsg = document.getElementById('login-error');
            
            errorMsg.classList.add('hidden');
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                errorMsg.textContent = "Erro: " + error.message;
                errorMsg.classList.remove('hidden');
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth);
        });

        // --- GITHUB ASSETS ---
        async function loadGitHubAssets() {
            assetsList.innerHTML = '<div class="text-gray-400 text-center text-xs p-4"><i class="fas fa-sync fa-spin mr-2"></i>Buscando imagens...</div>';
            
            let user = GITHUB_USER;
            let repo = GITHUB_REPO;

            try {
                const apiUrl = `https://api.github.com/repos/${user}/${repo}/contents/maps`;
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error('Falha ao listar arquivos');
                
                const files = await response.json();
                const images = files.filter(file => file.name.match(/\.(png|jpg|jpeg|gif|webp)$/i));

                assetsList.innerHTML = '';
                if (images.length === 0) assetsList.innerHTML = '<div class="text-gray-500 text-center p-4">Nenhuma imagem.</div>';

                images.forEach(file => {
                    createAssetItem(file.name, file.download_url || `./maps/${file.name}`);
                });
                assetsList.insertAdjacentHTML('beforeend', getCustomUrlBtn());

            } catch (error) {
                console.error(error);
                assetsList.innerHTML = `
                    <div class="text-red-400 text-xs p-2">Erro ao carregar imagens.</div>
                    ${getCustomUrlBtn()}
                `;
            }
        }

        function createAssetItem(name, url) {
            const div = document.createElement('div');
            div.className = "bg-gray-700 p-2 rounded cursor-pointer hover:bg-gray-600 transition flex items-center gap-2 group border border-gray-600 hover:border-blue-500";
            div.innerHTML = `
                <div class="w-10 h-10 bg-gray-900 rounded overflow-hidden flex items-center justify-center border border-gray-600 relative">
                    <img src="${url}" class="max-w-full max-h-full object-contain">
                </div>
                <div class="flex-1 min-w-0">
                    <div class="text-xs font-bold text-gray-300 truncate" title="${name}">${name}</div>
                </div>
                <i class="fas fa-plus-circle text-blue-400 opacity-0 group-hover:opacity-100 transition"></i>
            `;
            div.addEventListener('click', () => addMapPieceToCanvas(url));
            assetsList.appendChild(div);
        }

        function getCustomUrlBtn() {
            return `
                <div class="mt-4 border-t border-gray-700 pt-3">
                    <button id="btn-custom-url" class="w-full text-xs bg-gray-700 hover:bg-gray-600 p-2 rounded text-gray-300 border border-gray-600 border-dashed">
                        + URL
                    </button>
                </div>`;
        }
        
        document.addEventListener('click', function(e){
            if(e.target && e.target.id == 'btn-custom-url'){
                const url = prompt("Cole a URL da imagem:");
                if(url) addMapPieceToCanvas(url);
            }
        });

        // --- CANVAS LOGIC ---

        function addMapPieceToCanvas(src, existingData = null) {
            const id = existingData ? existingData.id : 'map_' + Date.now();
            
            const piece = document.createElement('div');
            piece.className = 'map-piece';
            piece.id = id;
            
            const img = document.createElement('img');
            img.src = src;
            img.draggable = false;
            img.style.pointerEvents = 'none'; 
            
            piece.appendChild(img);

            // Dados iniciais
            const data = existingData || {
                id: id,
                src: src,
                x: 100,
                y: 100,
                z: 1,
                mobs: '',
                drops: '',
                missions: ''
            };

            // Se novo, centraliza na visão atual
            if (!existingData) {
                // Calcular centro da visão considerando scroll e zoom
                const wrapper = document.getElementById('canvas-wrapper');
                // Pega o centro da viewport
                const viewportCX = wrapper.scrollLeft + (wrapper.clientWidth / 2);
                const viewportCY = wrapper.scrollTop + (wrapper.clientHeight / 2);
                
                // Converte para coordenadas do canvas (dividindo pelo zoom)
                data.x = Math.round(viewportCX / currentZoom);
                data.y = Math.round(viewportCY / currentZoom);
                
                currentMapData.push(data);
            }

            updateElementDOM(piece, data);

            // Eventos unificados
            piece.addEventListener('mousedown', (e) => {
                if(isEditorMode) {
                    startDragging(e, piece, data);
                }
            });
            
            // Lógica de clique (Edição vs Visita)
            piece.addEventListener('click', (e) => {
                e.stopPropagation(); // Impede propagar para o canvas
                
                if(isEditorMode) {
                    selectPiece(data.id);
                } else {
                    // Modo Visitante: Toggle Popup Info
                    toggleVisitorPopup(piece, data);
                }
            });

            mapCanvas.appendChild(piece);
        }

        function updateElementDOM(el, data) {
            el.style.left = `${data.x}px`;
            el.style.top = `${data.y}px`;
            el.style.zIndex = data.z;
        }

        // --- LÓGICA DE POPUP PARA VISITANTES (CLIQUE) ---
        function toggleVisitorPopup(piece, data) {
            // Se não tiver dados, não faz nada
            if (!data.mobs && !data.missions && !data.drops) return;

            // Se já estiver aberto nesse elemento, fecha
            if (activeInfoPopup === data.id) {
                closePopup();
                return;
            }

            // Fecha qualquer outro aberto
            closePopup();

            // Cria novo
            const popup = document.createElement('div');
            popup.className = 'info-popup';
            popup.id = `popup-${data.id}`;
            
            let content = '';
            if(data.mobs) content += `<div class="text-red-300 font-bold mb-2 pb-1 border-b border-gray-600"><i class="fas fa-skull mr-2"></i> ${data.mobs}</div>`;
            if(data.drops) content += `<div class="text-green-300 text-xs mb-2"><i class="fas fa-gem mr-1"></i> Drops: ${data.drops}</div>`;
            if(data.missions) content += `<div class="text-yellow-300"><i class="fas fa-exclamation-circle mr-1"></i> ${data.missions}</div>`;
            
            popup.innerHTML = content;
            
            // Adiciona ao canvas
            mapCanvas.appendChild(popup);
            activeInfoPopup = data.id;

            // Posiciona acima do elemento
            const pieceRect = piece.getBoundingClientRect(); // Tamanho visual
            // Coordenadas internas
            const pX = parseInt(piece.style.left);
            const pY = parseInt(piece.style.top);
            
            // Offset simples
            popup.style.left = pX + 'px';
            popup.style.top = (pY - 10) + 'px'; 
            // Ajuste fino com transform para subir 100% da altura do popup
            popup.style.transform = "translateY(-100%)";
        }

        function closePopup() {
            document.querySelectorAll('.info-popup').forEach(p => p.remove());
            activeInfoPopup = null;
        }

        // --- DRAG AND DROP (Modo Editor) ---
        let isDragging = false;
        let activeDragPiece = null;
        let activeDragData = null;
        let dragOffset = { x: 0, y: 0 };
        let isPanning = false; // Controle para Pan no modo visitante ou com Middle Click
        let panStart = { x: 0, y: 0, scrollLeft: 0, scrollTop: 0 };

        mapCanvas.addEventListener('mousedown', (e) => {
            // Lógica de Pan (Arrastar o mapa)
            // Se for botão do meio (1) ou botão esquerdo (0) no modo visitante
            if (e.button === 1 || (e.button === 0 && (!isEditorMode || e.target === mapCanvas))) {
                e.preventDefault();
                isPanning = true;
                panStart.x = e.clientX;
                panStart.y = e.clientY;
                panStart.scrollLeft = canvasWrapper.scrollLeft;
                panStart.scrollTop = canvasWrapper.scrollTop;
                mapCanvas.style.cursor = 'grabbing';
            }
            // Se clicar no fundo no modo editor, deseleciona e fecha popup
            if (e.target === mapCanvas) {
                if (isEditorMode) selectPiece(null);
                else closePopup();
            }
        });

        function startDragging(e, piece, data) {
            if (e.button !== 0) return; 
            e.preventDefault();
            selectPiece(data.id); 
            isDragging = true;
            activeDragPiece = piece;
            activeDragData = data;
            
            // Calcular offset levando em conta o Zoom
            const rect = piece.getBoundingClientRect();
            // Diferença visual em pixels
            const visualOffsetX = e.clientX - rect.left;
            const visualOffsetY = e.clientY - rect.top;
            
            // Converter para unidades internas do canvas (dividindo pelo zoom)
            dragOffset.x = visualOffsetX / currentZoom;
            dragOffset.y = visualOffsetY / currentZoom;
            
            document.addEventListener('mousemove', handleGlobalMove);
            document.addEventListener('mouseup', stopActions);
        }

        function handleGlobalMove(e) {
            // Handle Panning
            if (isPanning) {
                const dx = e.clientX - panStart.x;
                const dy = e.clientY - panStart.y;
                canvasWrapper.scrollLeft = panStart.scrollLeft - dx;
                canvasWrapper.scrollTop = panStart.scrollTop - dy;
                return;
            }

            // Handle Dragging Piece
            if (!isDragging) return;
            
            const canvasRect = mapCanvas.getBoundingClientRect();
            
            // Posição do mouse relativa ao topo-esquerdo do Canvas (visual)
            const relativeX = e.clientX - canvasRect.left;
            const relativeY = e.clientY - canvasRect.top;
            
            // Converter para coordenadas internas (Lógica de Zoom: Desfazer a escala)
            // Coord Interna = Coord Visual / Zoom
            let newX = (relativeX / currentZoom) - dragOffset.x;
            let newY = (relativeY / currentZoom) - dragOffset.y;
            
            // Pixel Perfect (Inteiros)
            newX = Math.round(newX);
            newY = Math.round(newY);

            activeDragPiece.style.left = `${newX}px`;
            activeDragPiece.style.top = `${newY}px`;
            
            activeDragData.x = newX;
            activeDragData.y = newY;
            
            if (selectedElementId === activeDragData.id) {
                document.getElementById('prop-x').value = newX;
                document.getElementById('prop-y').value = newY;
            }
            
            coordsDisplay.innerText = `X: ${newX} Y: ${newY}`;
        }

        function stopActions() {
            isDragging = false;
            activeDragPiece = null;
            activeDragData = null;
            
            if (isPanning) {
                isPanning = false;
                mapCanvas.style.cursor = isEditorMode ? 'default' : 'grab';
            }

            document.removeEventListener('mousemove', handleGlobalMove);
            document.removeEventListener('mouseup', stopActions);
        }
        
        // Listener global de movimento para Panning (já que é no wrapper)
        document.addEventListener('mousemove', handleGlobalMove);
        document.addEventListener('mouseup', stopActions);

        // --- SELEÇÃO ---
        function selectPiece(id) {
            if(!isEditorMode && id !== null) return;

            const prev = document.querySelector('.map-piece.selected');
            if (prev) prev.classList.remove('selected');
            
            if (id === null) {
                selectedElementId = null;
                noSelection.classList.remove('hidden');
                propPanel.classList.add('hidden');
                return;
            }

            selectedElementId = id;
            const el = document.getElementById(id);
            if (el) el.classList.add('selected');
            
            const data = currentMapData.find(d => d.id === id);
            if (data) showProperties(data);
        }

        function showProperties(data) {
            noSelection.classList.add('hidden');
            propPanel.classList.remove('hidden');

            document.getElementById('prop-src').value = data.src;
            document.getElementById('prop-x').value = data.x;
            document.getElementById('prop-y').value = data.y;
            document.getElementById('prop-z').value = data.z || 1;
            document.getElementById('prop-mobs').value = data.mobs || '';
            document.getElementById('prop-drops').value = data.drops || '';
            document.getElementById('prop-missions').value = data.missions || '';
        }

        // Inputs de propriedade
        ['prop-x', 'prop-y', 'prop-z', 'prop-mobs', 'prop-drops', 'prop-missions'].forEach(id => {
            document.getElementById(id).addEventListener('input', (e) => {
                if (!selectedElementId) return;
                const data = currentMapData.find(d => d.id === selectedElementId);
                if (!data) return;

                const val = e.target.value;
                const field = id.replace('prop-', '');
                
                if (field === 'x' || field === 'y' || field === 'z') {
                    data[field] = parseInt(val) || 0;
                    updateElementDOM(document.getElementById(selectedElementId), data);
                } else {
                    data[field] = val;
                }
            });
        });

        document.getElementById('delete-btn').addEventListener('click', () => {
            if (!selectedElementId) return;
            document.getElementById(selectedElementId).remove();
            currentMapData = currentMapData.filter(d => d.id !== selectedElementId);
            selectPiece(null);
        });

        // --- FIRESTORE ---

        saveBtn.addEventListener('click', async () => {
            const btn = saveBtn;
            const originalHTML = btn.innerHTML;
            
            try {
                btn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> ...`;
                btn.disabled = true;
                
                await setDoc(doc(db, "maps_data", "global_map"), {
                    pieces: currentMapData,
                    updatedAt: new Date(),
                    updatedBy: auth.currentUser.email
                });
                
                showToast("Salvo com sucesso!", "success");
            } catch (e) {
                console.error("Erro:", e);
                showToast("Erro ao salvar", "error");
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        });

        async function loadMapDataFromFirebase() {
            try {
                const docRef = doc(db, "maps_data", "global_map");
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const savedData = docSnap.data();
                    if (savedData.pieces && Array.isArray(savedData.pieces)) {
                        mapCanvas.innerHTML = '';
                        currentMapData = [];
                        
                        savedData.pieces.forEach(data => {
                            addMapPieceToCanvas(data.src, data);
                        });
                        
                        // Após carregar, tenta centralizar automaticamente
                        setTimeout(fitMapToScreen, 500); 
                    }
                }
            } catch (e) {
                console.error("Erro load:", e);
                showToast("Erro ao carregar mapa.", "error");
            }
        }

        function showToast(msg, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = `fixed bottom-4 right-4 text-white px-6 py-3 rounded shadow-lg transform transition-transform duration-300 border-l-4 z-50 ${
                type === 'error' ? 'bg-red-800 border-red-500' : 
                type === 'success' ? 'bg-green-800 border-green-500' : 
                'bg-gray-800 border-blue-500'
            }`;
            toast.style.transform = 'translateY(0)';
            setTimeout(() => { toast.style.transform = 'translateY(150%)'; }, 3000);
        }

    </script>
</body>
</html>
